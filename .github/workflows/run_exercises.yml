name: TP3 - Run CNN Exercises

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'exercises/**'
      - 'main.py'
      - 'requirements.txt'
      - '.github/workflows/run_exercises.yml'
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.10"

jobs:
  run-classification-exercises:
    name: Run Classification Exercises (1 & 2)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create .env file for MLflow
      run: |
        echo "MLFLOW_TRACKING_URI=${{ secrets.MLFLOW_TRACKING_URI }}" >> .env
        echo "MLFLOW_TRACKING_USERNAME=${{ secrets.MLFLOW_TRACKING_USERNAME }}" >> .env
        echo "MLFLOW_TRACKING_PASSWORD=${{ secrets.MLFLOW_TRACKING_PASSWORD }}" >> .env
        # The following are needed if you use a private S3-compatible storage for artifacts
        echo "MLFLOW_S3_ENDPOINT_URL=${{ secrets.MLFLOW_S3_ENDPOINT_URL }}" >> .env
        echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> .env
        echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> .env
    
    - name: Run Exercise 1 (Basic CNN)
      run: python3 main.py --exercise 1
      
    - name: Run Exercise 2 (ResNet)
      run: python3 main.py --exercise 2
